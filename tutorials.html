

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial &mdash; DeepQuest  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/hacks.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contact" href="help.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> DeepQuest
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Quality Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#training-a-qe-model">Training a QE model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#scoring">Scoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="help.html">Contact</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">DeepQuest</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="training-a-qe-model">
<h2>Training a QE model<a class="headerlink" href="#training-a-qe-model" title="Permalink to this headline">¶</a></h2>
<p>One can use DeepQuest to train QE models at either word, sentence or document-level.
In its current version, DeepQuest provides the following, multi-level, QE models:</p>
<blockquote>
<div><ul class="simple">
<li><strong>POSTECH</strong>: a two-stage end-to-end stacked neural architecture that combines a <em>Predictor</em> and an <em>Estimator</em>, designed by <a class="reference external" href="https://dl.acm.org/citation.cfm?id=3109480">Kim et al., 2017</a>.</li>
<li><strong>BiRNN</strong>: simple architecture relying on two bi-directional RNNs, designed by <a class="reference internal" href="#ive-et-al-2018">Ive et al., 2018</a>.</li>
</ul>
</div></blockquote>
<p id="ive-et-al-2018">Depending on the desired level of prediction, the configuration will differ, and this section aims to give a detailed description of the customised parameters.</p>
<p>The first step is to create a configuration file (see <a class="reference external" href="https://github.com/sheffieldnlp/deepQuest/blob/master/configs/example_config-WordQE.py">configs/example_config-WordQE.py</a> for an example), which defines the parameters of the model to train, starting with the definition of the task:</p>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">TASK_NAME</span></code>: name given to the task;</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SRC_LAN</span></code>, <code class="docutils literal notranslate"><span class="pre">TRG_LAN</span></code>: extensions of correspnding source language and MT files (target language file for Predictor);</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">DATA_ROOT_PATH</span></code>: directory where to find the data;</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">TEXT_FILES</span></code>: a (Python) dictionary that contains the names of the training, development and test sets (<em>without extension</em>).</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="0">
<li><code class="docutils literal notranslate"><span class="pre">INPUTS_IDS_DATASETS</span></code> – defines the datasets used to train the QE model</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">source_text</span></code> – source text</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_below</span></code> – target text (reference for Predictor, MT for Estimator) one position right-shifted target text (for left POSTECH context, the same as previous word with NMT-Keras Teacher)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">state_above</span></code> – target text (reference for Predictor, MT for Estimator) one position left-shifted target text (for right POSTECH context, the same as next word with NMT-Keras Teacher)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">target</span></code> – MT text unshifted to obtain Predictor scores for it</div>
<div class="line"><br /></div>
<div class="line"><strong>Note</strong>: only <code class="docutils literal notranslate"><span class="pre">source_text</span></code> and <code class="docutils literal notranslate"><span class="pre">target_text</span></code> inputs are used for biRNN models.</div>
</div>
</div></blockquote>
<ol class="arabic simple">
<li>For outputs of single-task models set an output in <code class="docutils literal notranslate"><span class="pre">OUTPUTS_IDS_DATASET</span></code> from the following (+ set <code class="docutils literal notranslate"><span class="pre">MULTI_TASK=False</span></code>, keep pre-set task names):</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">target_text</span></code> – for Predictor, Predictor training can be stopped after 2-3 epochs as soon as the quality in BLEU will stop improving</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">word_qe</span></code> – for word-level quality Estimator</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sent_qe</span></code> – for sentence-level quality Estimator</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">doc_qe</span></code> – for doc-level models</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><code class="docutils literal notranslate"><span class="pre">LOSS</span></code> – defines the loss function</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">categorical_crossentropy</span></code> for Predictor (POSTECH architecture), or word-level QE</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">mse</span></code> for sentence-level and document-level QE (regression optimization)</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><code class="docutils literal notranslate"><span class="pre">MODEL_TYPE</span></code> – defines the type of the model to train</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">POSTECH: Predictor, Estimator{Word, Sent, Doc, DocAtt}</div>
<div class="line">BiRNN: Enc{Word, Sent, Doc, DocAtt}</div>
<div class="line"><br /></div>
<div class="line"><strong>Note</strong>: document-level models take the last BiRNN states to produce the QE labels, while the document-level models with a Attention mechanism (DocAtt) take the sum of the BiRNN states, weighted by attention (see <em>model_zoo.py</em> for implementation details).</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li>Parameters per model type:</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WORD_QE_CLASSES</span></code> – constantly set to 5, except for OK and BAD labels , since we have a set of standard labels related to padding and other pre-processing</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SAMPLE_WEIGHTS</span></code> – to specify a dictionary using task names above, labels and their weights (for non-regression tasks, like word-level QE)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">PRED_SCORE</span></code> – set as the extension of the tag file, (<em>e.g. ``PRED_SCORE`` = ‘bleu’</em>), for both sentence and document-level QE, while for word-level QE, sets as ‘tags’ extension</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">DOC_SIZE</span></code> – <em>(for document-level QE only)</em> to fix the size of a document (<em>e.g.</em> to the maximum length of the most frequent quartile)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">DOC_ACTIVATION</span></code> – <em>(for document-level QE only)</em> set as ‘relu’ function if scores between (0, +infinity), as a ‘sigmoid’ function for scores similar to metrics such ash BLEU or HTER (<em>i.e.</em> between 0 and 1), or as a linear’ function for scores between (-Infinity, +infinity).</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="5">
<li><code class="docutils literal notranslate"><span class="pre">MULTI_TASK</span></code> – Multi-Tasks Learning (MTL) (POSTECH model only)</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">MULTI_TASK</span></code> = True / False, to activate / deactivate MTL</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">OUTPUTS_IDS_DATASET_FULL</span></code> – defines order for multiple outputs for Multi-Tasks Learning (MTL)</div>
<div class="line">Standard order of tasks: <code class="docutils literal notranslate"><span class="pre">target_text</span></code>, <code class="docutils literal notranslate"><span class="pre">word_qe</span></code>, <code class="docutils literal notranslate"><span class="pre">sent_qe</span></code> (<code class="docutils literal notranslate"><span class="pre">LOSS</span></code> and <code class="docutils literal notranslate"><span class="pre">MODEL_TYPE</span></code> will be ignored).</div>
<div class="line">The MTL will first pre-train the word-level weigths (keeping Predictor weights unchanged), and the <em>Estimator</em> (sentence-level).</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">EPOCH_PER_UPDATE</span></code> = 1 – times every task is consequently repeated (each of N epochs as specified by the parameters below)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EPOCH_PER_PRED</span></code> = 5 – Predictor epochs</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EPOCH_PER_EST_SENT</span></code> = 5 – EstimatorSent epochs</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EPOCH_PER_EST_WORD</span></code> = 5 – EstimatorWord epochs</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="6">
<li>Neural network parameters (should be kept the same for the large Predictor training and then MTL learning).</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">For a small <strong>POSTECH-inspired</strong> model the following parameters should be used:</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">IN{OUT}PUT_VOCABULARY_SIZE</span></code> = 30000</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SOURCE{TARGET}_TEXT_EMBEDDING_SIZE</span></code> = 300</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EN{DE}CODER_HIDDEN_SIZE</span></code> = 500</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">QE_VECTOR_SIZE</span></code> = 75</div>
</div>
<div class="line-block">
<div class="line">For a large <strong>POSTECH-inspired</strong> model:</div>
</div>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">IN{OUT}PUT_VOCABULARY_SIZE</span></code> = 70000</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SOURCE{TARGET}_TEXT_EMBEDDING_SIZE</span></code> = 500</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EN{DE}CODER_HIDDEN_SIZE</span></code> = 700</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">QE_VECTOR_SIZE</span></code> = 100</div>
</div>
<div class="line-block">
<div class="line">For document-level QE : <code class="docutils literal notranslate"><span class="pre">DOC_DECODER_HIDDEN_SIZE</span></code> = 50</div>
</div>
<div class="line-block">
<div class="line">For BiRNN models: <code class="docutils literal notranslate"><span class="pre">ENCODER_HIDDEN_SIZE</span></code> = 50</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="7">
<li>Other training-related parameters:</li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">PRED_VOCAB</span></code> – set the dictionary pickle dumped by the pre-trained model (dumped to the datasets folder)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">PRED_WEIGHTS</span></code> – set the pre-trained weights (as dumped to the trained_models/{model_name} folder)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">BATCH_SIZE</span></code> – typically 50 or 70 for smaller models; set to 5 for doc QE</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MAX_EPOCH</span></code> – max epochs the code will run (for MTL max quantity of iterations over all the three tasks)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MAX_IN(OUT)PUT_TEXT_LEN</span></code> – longer sequences are cut to the specified length</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">RELOAD</span></code> = {epoch_number}, combined with <code class="docutils literal notranslate"><span class="pre">RELOAD_EPOCH</span></code> = True – helpful when you want to continue training from a certain epoch, also a good idea to specify the vocabulary as previously pickeled (<code class="docutils literal notranslate"><span class="pre">PRED_VOCAB</span></code>)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">OPTIMIZER</span></code> = {optimizer}, also adjust the learning rate accordingly <code class="docutils literal notranslate"><span class="pre">LR</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">EARLY_STOP</span></code> = True  – activate early stopping with required <code class="docutils literal notranslate"><span class="pre">PATIENCE</span></code> = e.g. 5; set the right stop metric e.g. <code class="docutils literal notranslate"><span class="pre">STOP_METRIC</span></code> = e.g. ‘pearson’ (for regression QE tasks: alo ‘mae’, ‘rmse’; for classification tasks: ‘precision’, ‘recall’, ‘f1’)</div>
</div>
</div></blockquote>
<p>Once all the training parameters are defined in the configuration file, one can run the training of the QE model as follows:</p>
<blockquote>
<div><div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">KERAS_BACKEND</span><span class="o">=</span><span class="n">theano</span>
<span class="n">export</span> <span class="n">MKL_THREADING_LAYER</span><span class="o">=</span><span class="n">GNU</span>
<span class="n">THEANO_FLAGS</span><span class="o">=</span><span class="n">device</span><span class="o">=</span><span class="n">cuda</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">}</span> <span class="n">python</span> <span class="n">main</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">config</span> <span class="n">config</span><span class="o">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">deepQuest</span><span class="o">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</pre></div>
</div>
</div></blockquote>
<p>One can observe the progression of the training in the log file created in the temporary directory.</p>
</div>
<div class="section" id="scoring">
<h2>Scoring<a class="headerlink" href="#scoring" title="Permalink to this headline">¶</a></h2>
<p>Test sets are scored after each epoch using the standard tests from the <a class="reference external" href="http://www.statmt.org/wmt18/quality-estimation-task.html">WMT QE Shared task</a> metrics, with an inbuilt procedure.
New test sets with already trained models can be scored by launching the same command as for training. Change the following parameters in your initial config (see <a class="reference external" href="https://github.com/sheffieldnlp/deepQuest/blob/master/configs/config-sentQEbRNNEval.py">configs/config-sentQEbRNNEval.py</a> for an example, for now the scoring procedure is tested only for the sentence-level QE models):</p>
<blockquote>
<div><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">EVAL_ON_SETS</span></code> – specify the set for scoring</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">PRED_WEIGHTS</span></code> – set the path to the pre-trained weights (as dumped to the trained_models/{model_name} folder) of the model that would be used for scoring</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">MODE</span></code> – set to ‘sampling’</div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="help.html" class="btn btn-neutral float-right" title="Contact" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="installation.html" class="btn btn-neutral" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Julia Ive, Fred Blain, Lucia Specia.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>